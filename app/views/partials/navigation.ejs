<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-sm gradient-navbar">
  <div class="container-fluid">

    <!-- Brand -->
    <a class="navbar-brand d-flex align-items-center fw-bold" href="/dashboard">
      <i class="fas fa-graduation-cap me-2" style="color: #ffd700;"></i>
      EDU LMS
      <small class="text-light ms-2 fw-normal">Learn. Grow. Achieve.</small>
    </a>

    <!-- Mobile Toggle -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar Content -->
    <div class="collapse navbar-collapse" id="navbarContent">

      <!-- Left Menu -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link px-3 <%= activePage === 'dashboard' ? 'active' : '' %>" href="/dashboard">
            <i class="fas fa-tachometer-alt me-1"></i>My Learning Space
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link px-3 <%= activePage === 'courses' ? 'active' : '' %>" href="/courses">
            <i class="fas fa-book me-1"></i>My Courses
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link px-3 <%= activePage === 'assignments' ? 'active' : '' %>" href="/assignments">
            <i class="fas fa-tasks me-1"></i>Assignments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link px-3 <%= activePage === 'grades' ? 'active' : '' %>" href="/grades">
            <i class="fas fa-chart-bar me-1"></i>Performance
          </a>
        </li>

        <% if (user && (user.role === 'teacher' || user.role === 'admin')) { %>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle px-3 <%= activePage === 'management' ? 'active' : '' %>" href="javascript:void(0)" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-cogs me-1"></i>Management
          </a>
          <ul class="dropdown-menu shadow-sm">
            <% if (user.role === 'admin') { %>
              <li><a class="dropdown-item" href="/admin/users">User Management</a></li>
              <li><a class="dropdown-item" href="/admin/courses">Course Management</a></li>
              <li><hr class="dropdown-divider"></li>
            <% } %>
            <li><a class="dropdown-item" href="/courses/create">Create Course</a></li>
            <li><a class="dropdown-item" href="/assignments/create">Create Assignment</a></li>
          </ul>
        </li>
        <% } %>
      </ul>

      <!-- Right Menu -->
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">

        <!-- Dark Mode Switch -->
        <li class="nav-item d-flex align-items-center px-3">
          <label class="switch mb-0">
            <input type="checkbox" id="themeToggle">
            <span class="slider round"></span>
          </label>
          <small class="text-light ms-2">Dark Mode</small>
        </li>

        <!-- Notifications -->
        <li class="nav-item dropdown">
          <a class="nav-link position-relative px-3" href="javascript:void(0)" id="notificationDropdown" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-bell"></i>
            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
          </a>
          <ul id="notificationList" class="dropdown-menu dropdown-menu-end shadow">
            <li><h6 class="dropdown-header">Notifications</h6></li>
            <div id="notifications"></div>
            <li><a class="dropdown-item text-center" id="viewAllNotifications" href="javascript:void(0)">View all notifications</a></li>
          </ul>
        </li>

        <!-- Messages -->
        <li class="nav-item dropdown">
          <a class="nav-link position-relative px-3" href="javascript:void(0)" id="messageDropdown" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-envelope"></i>
            <span id="messageBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">0</span>
          </a>
          <ul id="messageList" class="dropdown-menu dropdown-menu-end shadow">
            <li><h6 class="dropdown-header">Messages</h6></li>
            <div id="messages"></div>
            <li><a class="dropdown-item text-center" href="#">View all messages</a></li>
          </ul>
        </li>

        <!-- User Profile -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle px-3 d-flex align-items-center" href="javascript:void(0)" role="button" data-bs-toggle="dropdown">
            <i class="fas fa-user me-1"></i>
            <% if (user) { %><span>Welcome, <%= user.name %>!</span><% } else { %>Guest<% } %>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="/settings/profile"><i class="fas fa-user me-2"></i>My Profile</a></li>
            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>Settings</a></li>
            <li><a class="dropdown-item" href="/settings/help"><i class="fas fa-question-circle me-2"></i>Help & Support</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="/auth/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
          </ul>
        </li>
      </ul>

      <!-- Search -->
      <form class="d-flex ms-3 align-items-center">
        <div class="input-group">
          <input class="form-control form-control-sm rounded-start" type="search" placeholder="Search..." aria-label="Search">
          <button class="btn btn-outline-light btn-sm rounded-end" type="submit"><i class="fas fa-search"></i></button>
        </div>
      </form>
    </div>
  </div>
</nav>

<style>
.gradient-navbar { background: linear-gradient(90deg, #0b0c10, #1f2937); transition: background 0.4s ease; }
.navbar .nav-link { color: #e0e0e0; padding: 10px 15px; border-radius: 5px; transition: all 0.3s ease; }
.navbar .nav-link:hover { color: #ffd700; background: rgba(255, 215, 0, 0.15); }
.navbar .nav-link.active { background: linear-gradient(90deg, #1f6feb, #10b981); color: white; font-weight: bold; }
.dropdown-menu { background: #1e293b; border-radius: 5px; padding: 0.5rem 0; }
.dropdown-item { color: #e0e0e0; padding: 8px 20px; }
.dropdown-item:hover { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #667eea; }
input:checked + .slider:before { transform: translateX(20px); }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Dark Mode
  const toggle = document.getElementById('themeToggle');
  toggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode', toggle.checked);
    localStorage.setItem('darkMode', toggle.checked);
  });
  if (localStorage.getItem('darkMode') === 'true') {
    toggle.checked = true;
    document.body.classList.add('dark-mode');
  }

  const role = "<%= user ? user.role : 'guest' %>";
  let notificationPath = "/notifications/count";
  if (role === "student") notificationPath = "/student/notifications/count";
  else if (role === "teacher") notificationPath = "/teacher/notifications/count";
  else if (role === "admin") notificationPath = "/admin/notifications/count";

  // Notifications
  fetch(notificationPath)
    .then(res => res.json())
    .then(data => {
      document.getElementById('notificationBadge').textContent = data.count || 0;
      const notifContainer = document.getElementById('notifications');
      notifContainer.innerHTML = '';
      if (data.notifications && data.notifications.length) {
        data.notifications.forEach(n => {
          const item = document.createElement('li');
          item.innerHTML = `<a class="dropdown-item" href="${n.link}">${n.message}</a>`;
          notifContainer.appendChild(item);
        });
      } else {
        notifContainer.innerHTML = `<li><a class="dropdown-item text-center text-muted" href="javascript:void(0)">No notifications</a></li>`;
      }
      document.getElementById('viewAllNotifications').href = `/${role}/notifications`;
    })
    .catch(console.error);

  // Messages
  fetch('/messages/count')
    .then(res => res.json())
    .then(data => {
      document.getElementById('messageBadge').textContent = data.count || 0;
      const msgContainer = document.getElementById('messages');
      msgContainer.innerHTML = '';
      if (data.messages && data.messages.length) {
        data.messages.forEach(m => {
          const item = document.createElement('li');
          item.innerHTML = `<a class="dropdown-item" href="${m.link}">${m.message}</a>`;
          msgContainer.appendChild(item);
        });
      } else {
        msgContainer.innerHTML = `<li><a class="dropdown-item text-center text-muted" href="javascript:void(0)">No messages</a></li>`;
      }
    })
    .catch(console.error);
});
</script>
